package com_ravnaandtines;

import net.sf.functionalj.tuple.*;

/*
Three Domes (plus one)
To reconcile all published sources, including the Elder Secrets map, the model requires three primary domes.
 
Primary Sky Dome—Polaris Dome
The main star dome contains the Pole Star and most of the other stars and constellations. 
 It is designated the Polaris Dome. At midsummer (Day 67.5), the Polaris Dome 
 (and thus the Pole Star) is exactly in the center of the Sky.
The Polaris Dome does not tilt north. Instead, for 147 Days after the summer solstice, 
 it tilts to the south, then tilts northwards back to
center for 147 days. It thus is at its farthest southern extent at Day 214.5 (the winter solstice).
 * 
The Polaris Dome tilts exactly 15.947° to the south, then another 15.947° back northwards. 
 Although it would be ideal if the speed of this
tilt could accelerate and decelerate (as discussed in the 00 file), 
 without that modeling in place this results in movement of 0.1085° per Day.
(If this modeling can be applied, acceleration and deceleration could be 7 Days each?)
 * 
 
Stars and Constellations
The Polaris Dome contains all stars and constellations except: Stormgate, Zenith, 
 and the stars/constellations of the secondary dome (see
below). Additionally, because it travels upon the Celestial River, 
 the Boat Plant/Diros/Anaxial acts as if it is upon this dome. (And thus it
effectively tilts during the year.) No other planets, no special bodies, 
 and the Red Moon are not considered to be on this dome.
Orientation
 * 
The Polaris Dome is oriented such that at dusk on the Spring Equinox, 
 Lightfore rises exactly in the star called Youth. Put another way, at
day 0.75 (approximately, should actually be very slightly later than that 
 because we are 3/4 day past the moment of equinox), the star named
Youth should be exactly in the East.
However, it is also important that the star labeled Arraz be due south at the 
 moment of the winter solstice (Day 214.5). If these two sets
of data are close, but not exact, use Arraz as the determinant. 
 If there is any discrepency, I will need to see the model to try to reconcile it. (I
used my own model to verify that both worked, but I can’t guarantee 
 I didn’t screw something up.) Regardless, the exact points that serve as
the pivots for the Sunpath tilt never move, always being exactly east and west.

 Rotation
As stated in the 00 file, the Polaris Dome rotates at a rate of 360*(295/294) 
 degrees each Day, or 361.2244° each Day (14.45° per hour).
 * 
Sources
Elder Secrets: In midsummer it [Lorion] sits low in the southern sky, 
 partially obscured by the horizon, ... and in midwinter it sits high in the
north, above the Ice Palace.
 * 
Elder Secrets: The Sword Stars ... sit in the northern horizon, 
 and in summer are on the horizon, but in winter are high in the sky.
 * 
 * ------------------------
 * 
Secondary Sky Dome—Arnstadum Dome
The secondary sky dome contains those few stars and constellations that 
 do not rotate, instead always remaining in a fixed direction. At the
moment, this consists of five constellations and no other stars, 
 although it is possible that other stars and/or constellations might be added in
the future. This dome is designated the Arnstadum Dome.
The Arnstadum Dome is exactly at the center of the sky at the moments 
 of equinox (Day 0.0 and Day 135.0). It is at its farthest northern
extent at the summer solstice (Day 67.5), and at its farthest southern 
 extent at the winter solstice (Day 214.5). Thus, it tilts farther to the south
than it does to the north.
 * 
The Arnstadum Dome tilts 13.54° north at midsummer, and 15.947° south 
 at midwinter. (This is in a ratio of 67.5 north to 79.5 south, the
exact ratio of the number of days between the equinoxes and the summer and 
 winter solstices, respectively.) Although it would be ideal if
the speed of this tilt could accelerate and decelerate (as discussed in the 
 00 file), without that modeling in place this results in movement of
0.22438° per Day. (If this modeling can be applied, acceleration and 
 deceleration could be 7 Days each?)
 * 
Stars and Constellations
The Arnstadum Dome contains two constellations in the north: 
 Ice Palace/Winter Palace and Hollri/Hend/Henadus. It also contains three
constellations in the south: Southern Spear/Pamalt’s Spear/Erlandus’ Spear, 
 Ark of Fire, and Dragon Heart.
It is possible, but not certain, that Stormgate tilts with the Arnstadum Dome.
 * 
Orientation
The exact points that serve as the pivots for the Sunpath tilt never move, 
 always being exactly east and west.
The Arnstadum Dome is oriented such that the “highest” star of Ice Palace 
 is exactly north of Pole Star, and the “highest” star of the
Southern Spear is exactly south of Pole Star. These two constellations should 
 be placed at distances such that each of these “highest” stars
becomes visible at specified times (yet to be determined), and that the 
 “lowest” star of the Southern Spear and the “third lowest” star of the
Ice Palace be visible only at the night of greatest tilt north or south, 
 respectively. The other constellations are governed by where they appear
in relation to these two.
Sources
Elder Secrets: The sky dome rocks on a north-south axis. In summer it tilts 
 north, exposing stars in the south that are invisible in the winter
and sending the Sun’s path to the north of the center of the sky. In winter 
 the dome rocks back, exposing northern stars and concealing the
southern, and making the Sun’s path cross the sky south of the center. 
 The God Learners believed that the sky spilled its “burningness”
during its winter tilt, warming the southlands and making the Ocean of 
 Fire there. [If it spills heat only in the south, and not in the north, that
implies a tilt farther south than north.]
 * 
Tertiary Sky Dome—Lightfore Dome
The third sky dome contains the Sunpath. Having the Sunpath tilt distinctly 
 from the main and secondary sky domes is required to accurately
model the ES map. The Sunpath tilts on a dome designated the Lightfore Dome. 
 This dome’s tilt speed is not primarily constant.
The Lightfore Dome tilts 13.54° north at midsummer, and 15.947° south at 
 midwinter. (This is in a ratio of 67.5 north to 79.5 south, the
exact ratio of the number of days between the equinoxes and the summer 
 and winter solstices, respectively.) However, despite tilting farther
south than north, it is exactly at the center of the sky at the 1st and 
 3rd Quarter Days of the Year (Day 188.0 and Day 141.0); it is at its farthest
northern extent at the summer solstice (2nd Quarter Day, Day 67.5), and 
 at its farthest southern extent at the winter solstice (4th Quarter Day,
Day 214.5). Thus, its speed of tilt is not constant—it spends 12.0 Days 
 longer north of center than the Arnstadum Dome, despite tilting the
same amount (or so I think at this time, the model might change once I see 
 it in action). Thus, it takes 73.5 days to travel from its farthest
northern extent to the center of the Sky, another 73.5 days to reach its 
 farthest southern extent, another 73.5 days to return back to center, then
73.5 days to reach its farthest northern extent. It would be ideal if its 
 movement could be based on some sort of sinusoidal curve to have its
speed increase as it heads south, decelerate for about 7 days to reach its 
 farthest southern extent, accelerate smoothly as it heads north, then
decelerate for about 7 days as it approaches its northern terminus. 
 (But, as I said, that would be ideal.)
Stars and Constellations
Four planets (Lightfore, Uleria/Mastakos, Entekos/Moskalf, and Wagon/Lokarnos) 
 plus the Sun move along the Sunpath, and are thus
affected by this tilt. It is also possible that a sixth, invisible body, 
 travels along the Sunpath, but this is very esoteric, and not important at this
stage.
It is possible, but not certain, that Stormgate tilts with the Lightfore Dome.
Orientation
Exact timing of the five (or six) Sunpath bodies will be explored in a later 
 chapter. However, Lightfore in particular always rises at Dusk and
sets at Dawn, while the Sun always rises at Dawn and sets at Dusk. Regardless, 
 the exact points that serve as the pivots for the Sunpath tilt
never move, always being exactly east and west.
Sources
Elder Secrets: The sky dome rocks on a north-south axis. In summer it tilts 
 north, exposing stars in the south that are invisible in the winter
and sending the Sun’s path to the north of the center of the sky. 
 In winter the dome rocks back, exposing northern stars and concealing the
southern, and making the Sun’s path cross the sky south of the center. 
 The God Learners believed that the sky spilled its “burningness”
during its winter tilt, warming the southlands and making the Ocean of 
 Fire there. [If it spills heat only in the south, and not in the north, that
implies a tilt farther south than north.]
Other Bodies
Red Moon, Zenith
If one considers that the Red Moon and Zenith are unmoving, there should be a 
 dome (or domes) that do not rotate or tilt, upon which these
two bodies sit. While this may be true for the Red Moon, Zenith is in fact 
 a stationary weather balloon/satellite that sits high in the Sky, but
nowhere near as high as any of the Celestial Bodies. What effect this has 
 on its appearance from various parts of Glorantha, I am unsure at
this time.
The Southpath
At this time, I am uncertain whether or not the Southpath planets tilt in 
 the same way that the Sunpath does. At the moment, I am treating its
points as being set in their areas of the eastern and western sky, without 
 moving northward and southward throughout the year.
“Heaven Corrupted” and Other Celestial Events
The following explains the reasoning for the tilts selected above.
Ignoring identities (Umath/Orlanth, Yelm/Lightfore), and concentrate on the 
 Broken Ring and the Sun. If the dome broke first when the
Sun was still in the sky, it would be the Sunpath that was affected, NOT the 
 star dome. Thus, the Sunpath was pushed north first, then even
further south. Spring Equinox thus corresponds to the Perfect Realm; that the 
 Sun went farther north during the Gods War is OK, since this
corresponds to the later Golden Age, and gives Dara Happa their 
 “Yelm is directly above us” belief.
After a period of time, the Sun moves back to center; this corresponds 
 to the Autumnal Equinox AND to the Doom Conjunction (which
shows the Sun in the center of the Sky, but must be after the 
 Death of Umatum, since Orlanth is said to be the Murderer of Yelm), and so
the Sun is killed at this time (with the Broken Ring in the position noted in 
 GRoY). The Sunpath then continues to move southwards, which
corresponds to the Lesser Sun of the Great Darkness. Antirius’ death 
 probably corresponds to the winter solstice, when the dome is at its
farthest southern extent. At this time, it is revealed that Arraz is no 
 longer the Pole Star; instead it is Polaris. Since we know from the Doom
Conjunction that Arraz was still in the center of the Sky at the Autumnal 
 Equinox, it must be the Winter Solstice that defines the position of
Polaris and Arraz. At that time, Arraz is, or is extremely close to, due 
 south of Polaris. Thus, the Arraz-Polaris distance should correspond to
the Winter Solstice, and thus to the southern tilt, with the northern 
 tilt being (67.5/79.5) of that distance.
 */

/**
 *  Class ClassName 
 *
 *  Coded & copyright Mr. Tines <tines@windsong.demon.co.uk> 1998
 *  All rights reserved.  For full licence details see file Main.java
 *
 * @author Mr. Tines
 * @version 1.0 4-Apr-98
 *
 */
public final class E2Param {
    private E2Param() {}

    public static double domeRadius = 20.0;   // e6 meters
    public static boolean yuthu = false;  // sun overhead in yuthuppa midsummer
    public static double winterTilt = -10.6; //deg
    public static double equinoxTilt = 0;
    public static double summerTilt = 9.0;
    public static double summerDay = 0.1;       // deviation from 0.5 days
    public static double winterDay = -1.06 / 9.0;
    public static boolean uleria = false; // sidereal period
    public static double shargashRise = 0.0;
    public static double twinRise = 0.0;
    public static double artiaRise = 0.0;
    /*
     * The Spring Equinox is the same as the exact moment of the start of the
     * year, Day 0.0 (Freezeday/Disorder Week/Sea Season). Thus, the moment of
     * equinox is midnight. At this moment, Sun and Night are exactly of equal
     * length (12.5 hours each).
     *
     * The Summer Solstice is on day 68 (Fireday/Harmony Week/Fire Season),
     * with the exact moment of solstice being 67.5 (noon of day 68). Thus,
     * the moment of solstice is at noon. At this moment, Sun is the longest
     * of the year, and Night is the shortest.
     *
     * The Fall Equinox is at Day 135.0 (Clayday/Fertility Week/Earth Season).
     * Thus, the moment of equinox is midnight. At this moment, Sun and Night
     * are exactly of equal length (12.5 hours each).
     *
     * The Winter Solstice is on day 215 (Fireday/Illusion Week/Dark Season),
     * with the exact moment of solstice being 214.5 (noon of day 215). Thus,
     * the moment of solstice is at noon. At this moment, Night is the longest
     * of the year, and Sun is the shortest.
     */
    private static final double VERNAL_EQUINOX = 0.0; // was 0.5
    private static final double Q1 = 67.5; // equinox to summer solstice
    private static final double Q2 = 67.5; // solstice to autumnal equinox
    private static final double Q3 = 79.5; // equinox to winter solstice
    private static final double Q4 = 79.5; // solstice to vernal equinox

    /**
     * Return all free parameters to their defaults
     */
    public static void reset() {
        summerTilt = 9.0;
        winterTilt = -10.6;
        equinoxTilt = 0;
        summerDay = 0.1;
        winterDay = -1.06 / 9.0;
    }

    /**
     * Piecewise sinusoidal oscillation
     * @param week  which week of year
     * @param day   day within week
     * @param hour  time within day
     * @return      an annual oscillation centred at the equinoxes
     */
    private static double getHarmonic(final int week, final int day, final double hour) {
        // days since midnight on 1st day of year
        final double offset = (7.0 * week + day) + hour;

        // since equinox
        final double dday = (offset >= VERNAL_EQUINOX)
                ? offset - VERNAL_EQUINOX : offset - VERNAL_EQUINOX + 294;

        if (dday <= Q1) { //dday/q1
            final double cycle = dday * Math.PI / (Q1 + Q2);
            return Math.sin(cycle);
        } else if (dday <= Q1 + Q2) {  //(q1+q2-dday)/q2
            final double cycle = dday * Math.PI / (Q1 + Q2);
            return Math.sin(cycle);
        } else if (dday <= Q1 + Q2 + Q3) {  //(q1+q2 - dday)/q3
            final double cycle = (dday - (Q1 + Q2)) * Math.PI / (Q3 + Q4);
            return -Math.sin(cycle);
        } else {  //(dday - 294)/q4
            final double cycle = (dday - (Q1 + Q2)) * Math.PI / (Q3 + Q4);
            return -Math.sin(cycle);
        }
    }

    /**
     * Gets length of day given the seasonal oscillation
     * @param harmonic  Indication of season [-1, +1]
     * @return          length of solar day
     */
    private static double getDayLength(final double harmonic) // days
    {
        if (harmonic >= 0) {
            return 0.5 + summerDay * harmonic;
        } else {
            return 0.5 - winterDay * harmonic;
        }
    }
    
    /**
     * Gets the tilt of the Anaxial dome
     * <br>
     * At midsummer (Day 67.5), the Polaris Dome (and thus the Pole Star) is 
     * exactly in the centre of the Sky.
     * The Polaris Dome does not tilt north. Instead, for 147 Days after 
     * the summer solstice, it tilts to the south, then tilts northwards 
     * back to centre for 147 days. It thus is at its farthest southern extent 
     * at Day 214.5 (the winter solstice).
     * <br>
     * Applies to most constellations, plus Anaxial
     * @param harmonic
     * @return
     */
    private static double getPolarisDomeTilt(final double harmonic) // deg
    {
        return (harmonic - 1.0) * 15.947 /2.0;
    }
    
    /**
     * Gets the tilt of the Arnstadum dome
     * <br>
     * The Arnstadum Dome is exactly at the center of the sky at the moments 
     * of equinox (Day 0.0 and Day 135.0). It is at its farthest northern
     * extent at the summer solstice (Day 67.5), and at its farthest southern 
     * extent at the winter solstice (Day 214.5). Thus, it tilts farther to the south
     * than it does to the north.
     * <br>
     * The Arnstadum Dome tilts 13.54° north at midsummer, and 15.947° south 
     * at midwinter.
     * <br>
     * The Arnstadum Dome contains two constellations in the north:
     * Ice Palace/Winter Palace and Hollri/Hend/Henadus. It also contains three
     * constellations in the south: Southern Spear/Pamalt’s Spear/Erlandus’ Spear, 
     * Ark of Fire, and Dragon Heart.
     * <br>
     * It is possible, but not certain, that Stormgate tilts with
     * the Arnstadum Dome.
     * @param harmonic
     * @return
     */    
    private static double getArnstadumDomeTilt(final double harmonic) // deg
    {
            if (harmonic >= 0) {
                return 13.54 * harmonic;
            } else {
                return 15.947 * harmonic;
            }
    }
    
    /**
     * Gets the tilt of the Lightfore dome
     * <br>
     * The Lightfore Dome tilts 13.54° north at midsummer, and 15.947° south at 
     * midwinter. (This is in a ratio of 67.5 north to 79.5 south, the
     * exact ratio of the number of days between the equinoxes and the summer 
     * and winter solstices, respectively.) However, despite tilting farther
     * south than north, it is exactly at the center of the sky at the 1st and 
     * 3rd Quarter Days of the Year (Day 288.0 and Day 141.0); it is at its 
     * farthest northern extent at the summer solstice (2nd Quarter Day, 
     * Day 67.5), and at its farthest southern extent at the winter solstice 
     * (4th Quarter Day, Day 214.5).
     * <br>
     * Quarter period = 73.5 days
     * <br>
     * Day 288 => Day -6
     * <br>
     * Four planets (Lightfore, Uleria/Mastakos, Entekos/Moskalf, and 
     * Wagon/Lokarnos) plus the Sun move along the Sunpath, and are thus
     * affected by this tilt.
     * @param harmonic
     * @return
     */
    private static double getLightforeTilt(final int week, final int day, final double hour) {
        // days since end quarter
        final double offset = (7.0 * week + day) + hour + 6.0;
        
        final double raw = Math.sin(offset * Math.PI / 147.0);
        
        return getArnstadumDomeTilt(raw);
    }
    
    /**
     * Gets all dome tilts for an epocj
     * @param week  week of year
     * @param day   day of week
     * @param hour  time of day
     * @return {Polaris, Arnstadum, Lightfore} tilts in radians
     */
    public static Pair<Double, TripleUni<Double>> getTilts(final int week, final int day, final double hour)
    {
        final double harmonic = getHarmonic(week, day, hour);
        
        return new Pair<Double, TripleUni<Double>>(
                getDayLength(harmonic),
                new TripleUni<Double>(
                    getPolarisDomeTilt(harmonic),
                    getArnstadumDomeTilt(harmonic),
                    getLightforeTilt(week, day, hour)
                )
                );
    }
    
    /**
     * Tag enumeration
     */
    public enum TiltType
    {
        POLARIS,
        ARNSTADUM,
        LIGHTFORE     
    }
}

/* end of file E2Param.java */

